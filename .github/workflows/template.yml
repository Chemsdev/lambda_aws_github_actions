name: Deploy Lambda Layer

# ðŸ” DÃ©clenchement de lâ€™action : Ã  chaque push sur la branche main
on:
  push:
    branches:
      - main  

jobs:
  deploy-layer:
    runs-on: ubuntu-latest

    steps:

      # 1. RÃ©cupÃ¨re le code du dÃ©pÃ´t GitHub
      - name: ðŸ“¥ Checkout du repo
        uses: actions/checkout@v3

      # 2. Configure l'environnement Python dans GitHub Actions
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 3. Installe les dÃ©pendances dans le dossier layer/python
      - name: ðŸ§ª Installer les dÃ©pendances du layer
        run: |
          mkdir -p layer/python
          pip install -r lambda_function/requirements.txt -t layer/python

      # 4. CrÃ©e l'archive ZIP du layer (format attendu par AWS)
      - name: ðŸ—œï¸ CrÃ©er le zip du layer
        run: |
          cd layer
          zip -r ../my_layer.zip .
          cd ..

      # 5. Configure les identifiants AWS Ã  partir des secrets GitHub
      - name: ðŸ” Configurer AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id     : ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region            : eu-north-1  # ðŸ” adapte selon ta rÃ©gion AWS

      # 6. Publie le layer sur AWS Lambda et rÃ©cupÃ¨re son ARN
      - name: ðŸš€ Publier le layer sur AWS Lambda
        id: publish_layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name my-layer-test \
            --description "Layer auto-uploaded by GitHub Actions" \
            --zip-file fileb://my_layer.zip \
            --compatible-runtimes python3.12 \
            --query 'LayerVersionArn' --output text)
          echo "LAYER_ARN=$LAYER_ARN" >> $GITHUB_ENV

      # ðŸ”— 7. Met Ã  jour ta fonction Lambda en lui attachant le nouveau layer
      - name: ðŸ”— Attacher le layer Ã  la Lambda
        run: |
          aws lambda update-function-configuration \
            --function-name lambda_with_actions \
            --layers ${{ env.LAYER_ARN }}
